---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# Forecast case notifications using variant of concern strain dynamics

[![R-CMD-check](https://github.com/epiforecasts/forecast.vocs/workflows/R-CMD-check/badge.svg)](https://github.com/epiforecasts/forecast.vocs/actions/workflows/R-CMD-check.yaml) [![Codecov test coverage](https://codecov.io/gh/epiforecasts/forecast.vocs/branch/main/graph/badge.svg)](https://app.codecov.io/gh/epiforecasts/forecast.vocs)

This package contains models and processing code to allow sequencing of variants of concern to be used to forecast case notifications.

## Installation

Either install the package from GitHub using the following, 

```{r, eval = FALSE}
devtools::install_github("epiforecasts/forecast.vocs", dependencies = TRUE)
```

Install stan to enable model fitting and forecasting using:

```{r, eval = FALSE}
cmdstanr::install_cmdstan()
```

## Quick start

This quick start uses data from Germany that includes COVID-19 notificatons and sequences with sequences either being positive or negative for the Delta variant.

### Step by step forecast

```{r}
library(forecast.vocs)
options(mc.cores = 4)

obs <- filter_by_availability(
  germany_covid19_delta_obs,
  date = as.Date("2021-07-05")
)
curr_obs <- latest_obs(germany_covid19_delta_obs)

dt <- stan_data(obs, horizon = 4)

model <- load_model(strains = 2)

inits <- stan_inits(dt, strains = 2)

fit <- stan_fit(
  data = dt, model = model, init = inits,
  adapt_delta = 0.99, max_treedepth = 15,
  refresh = 0, show_messages = FALSE
)

posterior <- summarise_posterior(fit)
posterior <- update_voc_label(posterior, "Delta")
```

Plot the posterior prediction for cases.

```{r}
plot_cases(posterior, curr_obs, log = TRUE)
```

Plot the posterior prediction for the fraction of cases that have the Delta variant.

```{r}
plot_voc(posterior, curr_obs, voc_label = "Delta variant")
```

Plot the posterior estimate for the effective reproduction number of Delta and non-Delta cases.

```{r}
plot_rt(posterior)
```

### Forecast wrapper

Run a complete forecast for both the one and two strain models using the `forecast` function. This provides a wrapper around the individual functions used above. Multiple forecasts can be performed efficiently across dates and scenarios using `forecast_across_dates()` and `forecast_accross_scenarios()`.

```{r, message = FALSE}
forecasts <- forecast(obs,
  strains = c(1, 2),
  adapt_delta = 0.99, max_treedepth = 15,
  refresh = 0, show_messages = FALSE,
  probs = c(0.05, 0.2, 0.8, 0.95)
)
```

Unnest posterior estimates from each model.

```{r}
posteriors <- unnest_posterior(forecasts)
posteriors
```
Update variant of concern labels for the summarised posterior estimates.

```{r}
posteriors <- update_voc_label(posteriors, "Delta")
```

Generate summary plots for the forecasts:

```{r}
plots <- plot_posterior(
  posteriors, curr_obs,
  voc_label = "Delta variant"
)
```

Plot the posterior prediction for cases for both models.

```{r}
plots$log_cases
```

Plot the posterior estimate for the effective reproduction number of
Delta, non-Delta cases, and overall.

```{r}
plots$rt
```
